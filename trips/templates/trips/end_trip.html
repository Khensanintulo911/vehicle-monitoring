{% extends 'trips/base.html' %}

{% block title %}End Trip{% endblock %}

{% block content %}
<h2>End Trip: {{ trip.trip_number }}</h2>

<div class="card mb-3">
    <div class="card-body">
        <h5>{{ trip.job.customer_name }} - {{ trip.job.job_location }}</h5>
        <p><strong>Started:</strong> {{ trip.start_time|date:"Y-m-d H:i:s" }}</p>
        <p><strong>Start Odometer:</strong> {{ trip.start_odometer }} km</p>
    </div>
</div>

<form method="post" id="endTripForm">
    {% csrf_token %}
    <div class="mb-3">
        <label for="end_odometer" class="form-label">Ending Odometer (km)</label>
        <input type="number" step="0.1" class="form-control" id="end_odometer" name="end_odometer" required>
    </div>
    
    <div class="mb-3">
        <label for="end_fuel_level" class="form-label">Ending Fuel Level (litres or %)</label>
        <input type="number" step="0.01" class="form-control" id="end_fuel_level" name="end_fuel_level">
    </div>
    
    <div class="mb-3">
        <label for="notes" class="form-label">Notes</label>
        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
    </div>
    
    <input type="hidden" id="end_lat" name="end_lat">
    <input type="hidden" id="end_lng" name="end_lng">
    
    <div id="map"></div>
    
    <button type="submit" class="btn btn-success mt-3">Submit Trip</button>
    <a href="{% url 'active_trip' trip.id %}" class="btn btn-secondary mt-3">Cancel</a>
</form>
{% endblock %}

{% block extra_js %}
<script>
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('end_lat').value = position.coords.latitude;
            document.getElementById('end_lng').value = position.coords.longitude;
            
            var map = L.map('map').setView([position.coords.latitude, position.coords.longitude], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([position.coords.latitude, position.coords.longitude]).addTo(map)
                .bindPopup('Your Location').openPopup();
        });
    }
</script>
{% endblock %}
