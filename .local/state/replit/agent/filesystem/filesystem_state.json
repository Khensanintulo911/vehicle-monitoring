{"file_contents":{"manage.py":{"content":"#!/usr/bin/env python\n\"\"\"Django's command-line utility for administrative tasks.\"\"\"\nimport os\nimport sys\n\n\ndef main():\n    \"\"\"Run administrative tasks.\"\"\"\n    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'fleet_management.settings')\n    try:\n        from django.core.management import execute_from_command_line\n    except ImportError as exc:\n        raise ImportError(\n            \"Couldn't import Django. Are you sure it's installed and \"\n            \"available on your PYTHONPATH environment variable? Did you \"\n            \"forget to activate a virtual environment?\"\n        ) from exc\n    execute_from_command_line(sys.argv)\n\n\nif __name__ == '__main__':\n    main()\n","size_bytes":672},"fleet_management/settings.py":{"content":"\"\"\"\nDjango settings for fleet_management project.\n\nGenerated by 'django-admin startproject' using Django 4.2.7.\n\nFor more information on this file, see\nhttps://docs.djangoproject.com/en/4.2/topics/settings/\n\nFor the full list of settings and their values, see\nhttps://docs.djangoproject.com/en/4.2/ref/settings/\n\"\"\"\n\nfrom pathlib import Path\nimport os\n\n# Build paths inside the project like this: BASE_DIR / 'subdir'.\nBASE_DIR = Path(__file__).resolve().parent.parent\n\n\n# Quick-start development settings - unsuitable for production\n# See https://docs.djangoproject.com/en/4.2/howto/deployment/checklist/\n\n# SECURITY WARNING: keep the secret key used in production secret!\nSECRET_KEY = 'django-insecure-$8_q8#2wrurea*61ph1%izf-w+_e1%(6rw=u@r)8fev0vhlbpa'\n\n# SECURITY WARNING: don't run with debug turned on in production!\nDEBUG = True\n\nALLOWED_HOSTS = ['*']\n\n\n# Application definition\n\nINSTALLED_APPS = [\n    'django.contrib.admin',\n    'django.contrib.auth',\n    'django.contrib.contenttypes',\n    'django.contrib.sessions',\n    'django.contrib.messages',\n    'django.contrib.staticfiles',\n    'rest_framework',\n    'trips',\n]\n\nMIDDLEWARE = [\n    'django.middleware.security.SecurityMiddleware',\n    'django.contrib.sessions.middleware.SessionMiddleware',\n    'django.middleware.common.CommonMiddleware',\n    'django.middleware.csrf.CsrfViewMiddleware',\n    'django.contrib.auth.middleware.AuthenticationMiddleware',\n    'django.contrib.messages.middleware.MessageMiddleware',\n    'django.middleware.clickjacking.XFrameOptionsMiddleware',\n]\n\nROOT_URLCONF = 'fleet_management.urls'\n\nTEMPLATES = [\n    {\n        'BACKEND': 'django.template.backends.django.DjangoTemplates',\n        'DIRS': [],\n        'APP_DIRS': True,\n        'OPTIONS': {\n            'context_processors': [\n                'django.template.context_processors.debug',\n                'django.template.context_processors.request',\n                'django.contrib.auth.context_processors.auth',\n                'django.contrib.messages.context_processors.messages',\n            ],\n        },\n    },\n]\n\nWSGI_APPLICATION = 'fleet_management.wsgi.application'\n\n\n# Database\n# https://docs.djangoproject.com/en/4.2/ref/settings/#databases\n\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.postgresql',\n        'NAME': os.environ.get('PGDATABASE'),\n        'USER': os.environ.get('PGUSER'),\n        'PASSWORD': os.environ.get('PGPASSWORD'),\n        'HOST': os.environ.get('PGHOST'),\n        'PORT': os.environ.get('PGPORT'),\n    }\n}\n\n\n# Password validation\n# https://docs.djangoproject.com/en/4.2/ref/settings/#auth-password-validators\n\nAUTH_PASSWORD_VALIDATORS = [\n    {\n        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',\n    },\n    {\n        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',\n    },\n    {\n        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',\n    },\n    {\n        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',\n    },\n]\n\n\n# Internationalization\n# https://docs.djangoproject.com/en/4.2/topics/i18n/\n\nLANGUAGE_CODE = 'en-us'\n\nTIME_ZONE = 'UTC'\n\nUSE_I18N = True\n\nUSE_TZ = True\n\n\n# Static files (CSS, JavaScript, Images)\n# https://docs.djangoproject.com/en/4.2/howto/static-files/\n\nSTATIC_URL = 'static/'\nSTATIC_ROOT = BASE_DIR / 'staticfiles'\n\nMEDIA_URL = 'media/'\nMEDIA_ROOT = BASE_DIR / 'media'\n\nLOGIN_URL = '/accounts/login/'\nLOGIN_REDIRECT_URL = '/'\nLOGOUT_REDIRECT_URL = '/accounts/login/'\n\n# Default primary key field type\n# https://docs.djangoproject.com/en/4.2/ref/settings/#default-auto-field\n\nDEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'\n\n# REST Framework settings\nREST_FRAMEWORK = {\n    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',\n    'PAGE_SIZE': 100,\n}\n","size_bytes":3826},"replit.md":{"content":"# Fleet Management System\n\n## Overview\nA comprehensive fleet management system with trip logging capabilities for drivers and analytics dashboard for managers. Built with Django backend and Streamlit dashboard.\n\n## Recent Changes\n**November 21, 2025**\n- Initial project setup complete\n- Django backend with PostgreSQL database configured\n- Mobile-friendly driver interface created\n- REST API endpoints for data access\n- Streamlit analytics dashboard implemented\n- Sample data populated for testing\n\n## Project Architecture\n\n### Backend (Django)\n- **Framework**: Django 4.2.7 with Django REST Framework\n- **Database**: PostgreSQL (Replit-hosted)\n- **Key Models**:\n  - Driver: Driver information linked to User model\n  - Vehicle: Fleet vehicle details and odometer tracking\n  - Job: Customer jobs assigned to drivers\n  - Trip: Trip sheets with automatic metrics calculation\n  - TripEvent: Events logged during trips (delays, fuel stops, incidents, photos)\n  - GPSRoutePoint: GPS tracking points for route visualization\n\n### Frontend\n- **Mobile Interface**: Django templates with Bootstrap 5 and Leaflet.js for maps\n- **Dashboard**: Streamlit with Plotly charts and Folium maps\n- **REST API**: Available at `/api/` for dashboard and future integrations\n\n### Key Features Implemented\n1. Job assignment system with customer details and locations\n2. Trip logging (start → events → end) with GPS tracking\n3. Automatic calculations:\n   - Distance travelled (GPS + odometer)\n   - Duration and fuel consumption\n   - Route compliance checking\n   - After-hours detection\n   - Fuel efficiency (km/L)\n4. Event logging during trips (delays, fuel stops, incidents, photos)\n5. Admin interface for managers to assign jobs and view all data\n6. Analytics dashboard with performance metrics and route visualization\n\n## Access & Credentials\n\n### Admin Panel\nURL: http://0.0.0.0:5000/admin/\n- Username: `admin`\n- Password: `admin123`\n\n### Driver Interface\nURL: http://0.0.0.0:5000/\n- Driver 1: username `john`, password `driver123`\n- Driver 2: username `sarah`, password `driver123`\n\n### Streamlit Dashboard\nRun with: `streamlit run dashboard.py --server.port 8501`\nConnects to Django API at http://0.0.0.0:5000/api/\n\n## Sample Data\nThe system includes:\n- 2 drivers (John Smith, Sarah Johnson)\n- 2 vehicles (Bakkie #7, Van #3)\n- 3 jobs assigned to drivers\n\n## File Structure\n```\nfleet_management/          # Django project configuration\n  settings.py             # Database, apps, and middleware config\n  urls.py                 # Main URL routing\ntrips/                    # Main app\n  models.py              # Database models\n  views.py               # Mobile interface and API views\n  serializers.py         # REST API serializers\n  admin.py               # Admin interface configuration\n  templates/trips/       # Mobile interface templates\n    driver_dashboard.html\n    start_trip.html\n    active_trip.html\n    end_trip.html\n  templates/registration/\n    login.html\ndashboard.py             # Streamlit analytics dashboard\ncreate_sample_data.py    # Script to populate test data\nmanage.py                # Django management script\nrequirements.txt         # Python dependencies\n```\n\n## API Endpoints\nAll endpoints available at `/api/`:\n- `/api/drivers/` - List all drivers\n- `/api/vehicles/` - List all vehicles\n- `/api/jobs/` - List all jobs\n- `/api/trips/` - List all trips\n- `/api/trips/<id>/` - Trip details\n- `/api/trips/<id>/gps-route/` - GPS route points for a trip\n- `/api/trip-events/` - List all trip events\n\n## Development Notes\n- Django server runs on port 5000 (accessible to drivers)\n- Streamlit dashboard can run on port 8501\n- PostgreSQL database automatically configured via environment variables\n- Media files stored in `media/` directory for trip event photos\n- GPS coordinates captured automatically using browser geolocation API\n\n## Next Steps\n- Add real-time GPS tracking during active trips\n- Implement automated alerts for route deviations\n- Create comprehensive reporting features\n- Add batch export functionality (PDF, CSV)\n- Implement maintenance scheduling based on odometer readings\n","size_bytes":4098},"fleet_management/wsgi.py":{"content":"\"\"\"\nWSGI config for fleet_management project.\n\nIt exposes the WSGI callable as a module-level variable named ``application``.\n\nFor more information on this file, see\nhttps://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/\n\"\"\"\n\nimport os\n\nfrom django.core.wsgi import get_wsgi_application\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'fleet_management.settings')\n\napplication = get_wsgi_application()\n","size_bytes":409},"trips/urls.py":{"content":"from django.urls import path, include\nfrom rest_framework.routers import DefaultRouter\nfrom . import views\n\nrouter = DefaultRouter()\nrouter.register(r'drivers', views.DriverViewSet)\nrouter.register(r'vehicles', views.VehicleViewSet)\nrouter.register(r'jobs', views.JobViewSet)\nrouter.register(r'trips', views.TripViewSet)\nrouter.register(r'trip-events', views.TripEventViewSet)\nrouter.register(r'gps-points', views.GPSRoutePointViewSet)\n\nurlpatterns = [\n    path('', views.driver_dashboard, name='driver_dashboard'),\n    path('start-trip/<int:job_id>/', views.start_trip, name='start_trip'),\n    path('active-trip/<int:trip_id>/', views.active_trip, name='active_trip'),\n    path('add-event/<int:trip_id>/', views.add_trip_event, name='add_trip_event'),\n    path('end-trip/<int:trip_id>/', views.end_trip, name='end_trip'),\n    path('api/', include(router.urls)),\n]\n","size_bytes":865},"fleet_management/trips/apps.py":{"content":"from django.apps import AppConfig\n\n\nclass TripsConfig(AppConfig):\n    default_auto_field = 'django.db.models.BigAutoField'\n    name = 'trips'\n","size_bytes":142},"fleet_management/trips/models.py":{"content":"from django.db import models\n\n# Create your models here.\n","size_bytes":57},"fleet_management/__init__.py":{"content":"","size_bytes":0},"trips/serializers.py":{"content":"from rest_framework import serializers\nfrom .models import Driver, Vehicle, Job, Trip, TripEvent, GPSRoutePoint\n\n\nclass DriverSerializer(serializers.ModelSerializer):\n    full_name = serializers.SerializerMethodField()\n    username = serializers.CharField(source='user.username', read_only=True)\n    \n    class Meta:\n        model = Driver\n        fields = ['id', 'full_name', 'username', 'phone', 'license_number', 'is_active']\n    \n    def get_full_name(self, obj):\n        return str(obj)\n\n\nclass VehicleSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = Vehicle\n        fields = ['id', 'name', 'registration_number', 'vehicle_type', 'fuel_capacity', 'current_odometer', 'is_active']\n\n\nclass JobSerializer(serializers.ModelSerializer):\n    driver_name = serializers.SerializerMethodField()\n    vehicle_name = serializers.SerializerMethodField()\n    \n    class Meta:\n        model = Job\n        fields = ['id', 'job_number', 'customer_name', 'customer_phone', 'job_location', \n                  'job_location_lat', 'job_location_lng', 'description', 'instructions',\n                  'expected_duration', 'scheduled_start', 'assigned_driver', 'driver_name',\n                  'assigned_vehicle', 'vehicle_name', 'status', 'created_at']\n    \n    def get_driver_name(self, obj):\n        return str(obj.assigned_driver) if obj.assigned_driver else None\n    \n    def get_vehicle_name(self, obj):\n        return str(obj.assigned_vehicle) if obj.assigned_vehicle else None\n\n\nclass TripEventSerializer(serializers.ModelSerializer):\n    event_type_display = serializers.CharField(source='get_event_type_display', read_only=True)\n    \n    class Meta:\n        model = TripEvent\n        fields = ['id', 'trip', 'event_type', 'event_type_display', 'description', \n                  'location_lat', 'location_lng', 'photo', 'timestamp']\n\n\nclass GPSRoutePointSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = GPSRoutePoint\n        fields = ['id', 'trip', 'latitude', 'longitude', 'speed', 'timestamp']\n\n\nclass TripSerializer(serializers.ModelSerializer):\n    job_details = JobSerializer(source='job', read_only=True)\n    driver_name = serializers.SerializerMethodField()\n    vehicle_name = serializers.SerializerMethodField()\n    fuel_consumed = serializers.SerializerMethodField()\n    fuel_efficiency = serializers.SerializerMethodField()\n    events = TripEventSerializer(many=True, read_only=True)\n    \n    class Meta:\n        model = Trip\n        fields = ['id', 'trip_number', 'job', 'job_details', 'driver', 'driver_name', \n                  'vehicle', 'vehicle_name', 'start_time', 'end_time',\n                  'start_location_lat', 'start_location_lng', 'end_location_lat', 'end_location_lng',\n                  'start_odometer', 'end_odometer', 'start_fuel_level', 'end_fuel_level',\n                  'distance_travelled', 'duration_minutes', 'route_compliance', 'is_after_hours',\n                  'notes', 'status', 'fuel_consumed', 'fuel_efficiency', 'events', 'created_at']\n    \n    def get_driver_name(self, obj):\n        return str(obj.driver)\n    \n    def get_vehicle_name(self, obj):\n        return str(obj.vehicle)\n    \n    def get_fuel_consumed(self, obj):\n        return obj.get_fuel_consumed()\n    \n    def get_fuel_efficiency(self, obj):\n        return obj.get_fuel_efficiency()\n","size_bytes":3334},"trips/migrations/0001_initial.py":{"content":"# Generated by Django 4.2.7 on 2025-11-21 10:05\n\nfrom django.conf import settings\nfrom django.db import migrations, models\nimport django.db.models.deletion\n\n\nclass Migration(migrations.Migration):\n\n    initial = True\n\n    dependencies = [\n        migrations.swappable_dependency(settings.AUTH_USER_MODEL),\n    ]\n\n    operations = [\n        migrations.CreateModel(\n            name='Driver',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('phone', models.CharField(blank=True, max_length=20)),\n                ('license_number', models.CharField(blank=True, max_length=50)),\n                ('is_active', models.BooleanField(default=True)),\n                ('created_at', models.DateTimeField(auto_now_add=True)),\n                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),\n            ],\n            options={\n                'ordering': ['user__first_name', 'user__last_name'],\n            },\n        ),\n        migrations.CreateModel(\n            name='Job',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('job_number', models.CharField(max_length=50, unique=True)),\n                ('customer_name', models.CharField(max_length=200)),\n                ('customer_phone', models.CharField(blank=True, max_length=20)),\n                ('job_location', models.CharField(max_length=500)),\n                ('job_location_lat', models.DecimalField(blank=True, decimal_places=6, max_digits=9, null=True)),\n                ('job_location_lng', models.DecimalField(blank=True, decimal_places=6, max_digits=9, null=True)),\n                ('description', models.TextField()),\n                ('instructions', models.TextField(blank=True)),\n                ('expected_duration', models.IntegerField(help_text='Expected duration in minutes')),\n                ('scheduled_start', models.DateTimeField()),\n                ('status', models.CharField(choices=[('pending', 'Pending'), ('assigned', 'Assigned'), ('in_progress', 'In Progress'), ('completed', 'Completed'), ('cancelled', 'Cancelled')], default='pending', max_length=20)),\n                ('created_at', models.DateTimeField(auto_now_add=True)),\n                ('updated_at', models.DateTimeField(auto_now=True)),\n                ('assigned_driver', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='jobs', to='trips.driver')),\n            ],\n            options={\n                'ordering': ['-scheduled_start'],\n            },\n        ),\n        migrations.CreateModel(\n            name='Trip',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('trip_number', models.CharField(max_length=50, unique=True)),\n                ('start_time', models.DateTimeField(auto_now_add=True)),\n                ('end_time', models.DateTimeField(blank=True, null=True)),\n                ('start_location_lat', models.DecimalField(blank=True, decimal_places=6, max_digits=9, null=True)),\n                ('start_location_lng', models.DecimalField(blank=True, decimal_places=6, max_digits=9, null=True)),\n                ('end_location_lat', models.DecimalField(blank=True, decimal_places=6, max_digits=9, null=True)),\n                ('end_location_lng', models.DecimalField(blank=True, decimal_places=6, max_digits=9, null=True)),\n                ('start_odometer', models.DecimalField(decimal_places=1, help_text='Kilometers', max_digits=10)),\n                ('end_odometer', models.DecimalField(blank=True, decimal_places=1, help_text='Kilometers', max_digits=10, null=True)),\n                ('start_fuel_level', models.DecimalField(blank=True, decimal_places=2, help_text='Litres or Percentage', max_digits=5, null=True)),\n                ('end_fuel_level', models.DecimalField(blank=True, decimal_places=2, help_text='Litres or Percentage', max_digits=5, null=True)),\n                ('distance_travelled', models.DecimalField(blank=True, decimal_places=2, help_text='Kilometers', max_digits=10, null=True)),\n                ('duration_minutes', models.IntegerField(blank=True, null=True)),\n                ('route_compliance', models.DecimalField(blank=True, decimal_places=2, help_text='Percentage', max_digits=5, null=True)),\n                ('is_after_hours', models.BooleanField(default=False)),\n                ('notes', models.TextField(blank=True)),\n                ('status', models.CharField(choices=[('started', 'Started'), ('completed', 'Completed'), ('cancelled', 'Cancelled')], default='started', max_length=20)),\n                ('created_at', models.DateTimeField(auto_now_add=True)),\n                ('updated_at', models.DateTimeField(auto_now=True)),\n                ('driver', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='trips', to='trips.driver')),\n                ('job', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='trips', to='trips.job')),\n            ],\n            options={\n                'ordering': ['-start_time'],\n            },\n        ),\n        migrations.CreateModel(\n            name='Vehicle',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('name', models.CharField(max_length=100)),\n                ('registration_number', models.CharField(max_length=50, unique=True)),\n                ('vehicle_type', models.CharField(choices=[('bakkie', 'Bakkie'), ('van', 'Van'), ('truck', 'Truck'), ('car', 'Car')], max_length=50)),\n                ('fuel_capacity', models.DecimalField(decimal_places=2, help_text='Litres', max_digits=6)),\n                ('current_odometer', models.DecimalField(decimal_places=1, default=0, help_text='Kilometers', max_digits=10)),\n                ('is_active', models.BooleanField(default=True)),\n                ('created_at', models.DateTimeField(auto_now_add=True)),\n            ],\n            options={\n                'ordering': ['name'],\n            },\n        ),\n        migrations.CreateModel(\n            name='TripEvent',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('event_type', models.CharField(choices=[('delay', 'Delay'), ('fuel_stop', 'Fuel Stop'), ('incident', 'Incident/Damage'), ('arrival', 'Arrived at Customer'), ('completed', 'Completed Job'), ('photo', 'Photo Upload'), ('other', 'Other')], max_length=20)),\n                ('description', models.TextField()),\n                ('location_lat', models.DecimalField(blank=True, decimal_places=6, max_digits=9, null=True)),\n                ('location_lng', models.DecimalField(blank=True, decimal_places=6, max_digits=9, null=True)),\n                ('photo', models.ImageField(blank=True, null=True, upload_to='trip_events/')),\n                ('timestamp', models.DateTimeField(auto_now_add=True)),\n                ('trip', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='events', to='trips.trip')),\n            ],\n            options={\n                'ordering': ['timestamp'],\n            },\n        ),\n        migrations.AddField(\n            model_name='trip',\n            name='vehicle',\n            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='trips', to='trips.vehicle'),\n        ),\n        migrations.AddField(\n            model_name='job',\n            name='assigned_vehicle',\n            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='jobs', to='trips.vehicle'),\n        ),\n        migrations.CreateModel(\n            name='GPSRoutePoint',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('latitude', models.DecimalField(decimal_places=6, max_digits=9)),\n                ('longitude', models.DecimalField(decimal_places=6, max_digits=9)),\n                ('speed', models.DecimalField(blank=True, decimal_places=2, help_text='km/h', max_digits=5, null=True)),\n                ('timestamp', models.DateTimeField(auto_now_add=True)),\n                ('trip', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='gps_points', to='trips.trip')),\n            ],\n            options={\n                'ordering': ['timestamp'],\n            },\n        ),\n    ]\n","size_bytes":8727},"dashboard.py":{"content":"import streamlit as st\nimport pandas as pd\nimport plotly.express as px\nimport plotly.graph_objects as go\nimport requests\nfrom datetime import datetime, timedelta\nimport folium\nfrom streamlit_folium import st_folium\n\nst.set_page_config(page_title=\"Fleet Management Dashboard\", layout=\"wide\")\n\nAPI_BASE_URL = \"http://0.0.0.0:5000/api\"\n\n@st.cache_data(ttl=30)\ndef fetch_data(endpoint):\n    try:\n        response = requests.get(f\"{API_BASE_URL}/{endpoint}/\", timeout=5)\n        if response.status_code == 200:\n            return response.json()\n        return []\n    except:\n        return []\n\nst.title(\"Fleet Management Analytics Dashboard\")\n\ntab1, tab2, tab3, tab4 = st.tabs([\"Overview\", \"Trips\", \"Performance\", \"Map View\"])\n\nwith tab1:\n    st.header(\"Overview\")\n    \n    col1, col2, col3, col4 = st.columns(4)\n    \n    trips_data = fetch_data(\"trips\")\n    jobs_data = fetch_data(\"jobs\")\n    drivers_data = fetch_data(\"drivers\")\n    vehicles_data = fetch_data(\"vehicles\")\n    \n    with col1:\n        st.metric(\"Total Trips\", len(trips_data))\n    \n    with col2:\n        active_trips = [t for t in trips_data if t['status'] == 'started']\n        st.metric(\"Active Trips\", len(active_trips))\n    \n    with col3:\n        pending_jobs = [j for j in jobs_data if j['status'] == 'pending']\n        st.metric(\"Pending Jobs\", len(pending_jobs))\n    \n    with col4:\n        active_drivers = [d for d in drivers_data if d['is_active']]\n        st.metric(\"Active Drivers\", len(active_drivers))\n    \n    if trips_data:\n        df_trips = pd.DataFrame(trips_data)\n        df_trips['start_time'] = pd.to_datetime(df_trips['start_time'])\n        \n        st.subheader(\"Recent Trips\")\n        recent_trips = df_trips.sort_values('start_time', ascending=False).head(10)\n        \n        display_cols = ['trip_number', 'driver_name', 'vehicle_name', 'start_time', \n                        'distance_travelled', 'duration_minutes', 'status']\n        available_cols = [col for col in display_cols if col in recent_trips.columns]\n        st.dataframe(recent_trips[available_cols], use_container_width=True)\n\nwith tab2:\n    st.header(\"Trip Details\")\n    \n    if trips_data:\n        df_trips = pd.DataFrame(trips_data)\n        df_trips['start_time'] = pd.to_datetime(df_trips['start_time'])\n        \n        col1, col2 = st.columns(2)\n        \n        with col1:\n            completed_trips = df_trips[df_trips['status'] == 'completed']\n            if not completed_trips.empty and 'distance_travelled' in completed_trips.columns:\n                completed_trips['distance_travelled'] = pd.to_numeric(\n                    completed_trips['distance_travelled'], errors='coerce'\n                )\n                avg_distance = completed_trips['distance_travelled'].mean()\n                st.metric(\"Average Distance per Trip\", f\"{avg_distance:.1f} km\" if pd.notna(avg_distance) else \"N/A\")\n        \n        with col2:\n            if not completed_trips.empty and 'duration_minutes' in completed_trips.columns:\n                completed_trips['duration_minutes'] = pd.to_numeric(\n                    completed_trips['duration_minutes'], errors='coerce'\n                )\n                avg_duration = completed_trips['duration_minutes'].mean()\n                st.metric(\"Average Trip Duration\", f\"{avg_duration:.0f} min\" if pd.notna(avg_duration) else \"N/A\")\n        \n        st.subheader(\"Trips Over Time\")\n        df_trips['date'] = df_trips['start_time'].dt.date\n        trips_by_date = df_trips.groupby('date').size().reset_index(name='count')\n        fig = px.line(trips_by_date, x='date', y='count', title='Daily Trip Count')\n        st.plotly_chart(fig, use_container_width=True)\n        \n        if 'distance_travelled' in df_trips.columns:\n            st.subheader(\"Distance Distribution\")\n            fig = px.histogram(completed_trips, x='distance_travelled', \n                             title='Trip Distance Distribution', nbins=20)\n            st.plotly_chart(fig, use_container_width=True)\n    else:\n        st.info(\"No trip data available yet.\")\n\nwith tab3:\n    st.header(\"Driver Performance\")\n    \n    if trips_data:\n        df_trips = pd.DataFrame(trips_data)\n        \n        if 'driver_name' in df_trips.columns:\n            driver_stats = df_trips.groupby('driver_name').agg({\n                'trip_number': 'count',\n                'distance_travelled': lambda x: pd.to_numeric(x, errors='coerce').sum(),\n                'duration_minutes': lambda x: pd.to_numeric(x, errors='coerce').sum(),\n                'fuel_consumed': lambda x: pd.to_numeric(x, errors='coerce').sum()\n            }).reset_index()\n            \n            driver_stats.columns = ['Driver', 'Total Trips', 'Total Distance (km)', \n                                   'Total Duration (min)', 'Total Fuel (L)']\n            \n            st.subheader(\"Driver Statistics\")\n            st.dataframe(driver_stats, use_container_width=True)\n            \n            col1, col2 = st.columns(2)\n            \n            with col1:\n                fig = px.bar(driver_stats, x='Driver', y='Total Trips', \n                           title='Trips per Driver')\n                st.plotly_chart(fig, use_container_width=True)\n            \n            with col2:\n                fig = px.bar(driver_stats, x='Driver', y='Total Distance (km)', \n                           title='Distance per Driver')\n                st.plotly_chart(fig, use_container_width=True)\n        \n        completed = df_trips[df_trips['status'] == 'completed']\n        if not completed.empty:\n            st.subheader(\"Route Compliance\")\n            if 'route_compliance' in completed.columns:\n                completed['route_compliance'] = pd.to_numeric(\n                    completed['route_compliance'], errors='coerce'\n                )\n                avg_compliance = completed['route_compliance'].mean()\n                st.metric(\"Average Route Compliance\", \n                         f\"{avg_compliance:.1f}%\" if pd.notna(avg_compliance) else \"N/A\")\n            \n            st.subheader(\"After-Hours Usage\")\n            if 'is_after_hours' in completed.columns:\n                after_hours_count = completed['is_after_hours'].sum()\n                total_count = len(completed)\n                st.metric(\"After-Hours Trips\", \n                         f\"{after_hours_count} ({after_hours_count/total_count*100:.1f}%)\" if total_count > 0 else \"0\")\n    else:\n        st.info(\"No performance data available yet.\")\n\nwith tab4:\n    st.header(\"Trip Routes Map View\")\n    \n    if trips_data:\n        trip_options = [f\"{t['trip_number']} - {t.get('driver_name', 'Unknown')}\" \n                       for t in trips_data]\n        \n        if trip_options:\n            selected_trip_str = st.selectbox(\"Select a trip to view route\", trip_options)\n            selected_index = trip_options.index(selected_trip_str)\n            selected_trip = trips_data[selected_index]\n            \n            trip_id = selected_trip['id']\n            \n            col1, col2 = st.columns(2)\n            with col1:\n                st.write(f\"**Trip Number:** {selected_trip['trip_number']}\")\n                st.write(f\"**Driver:** {selected_trip.get('driver_name', 'Unknown')}\")\n                st.write(f\"**Status:** {selected_trip['status']}\")\n            \n            with col2:\n                st.write(f\"**Distance:** {selected_trip.get('distance_travelled', 'N/A')} km\")\n                st.write(f\"**Duration:** {selected_trip.get('duration_minutes', 'N/A')} min\")\n                st.write(f\"**Route Compliance:** {selected_trip.get('route_compliance', 'N/A')}%\")\n            \n            start_lat = selected_trip.get('start_location_lat')\n            start_lng = selected_trip.get('start_location_lng')\n            end_lat = selected_trip.get('end_location_lat')\n            end_lng = selected_trip.get('end_location_lng')\n            \n            if start_lat and start_lng:\n                m = folium.Map(location=[float(start_lat), float(start_lng)], zoom_start=12)\n                \n                folium.Marker(\n                    [float(start_lat), float(start_lng)],\n                    popup=\"Start Location\",\n                    icon=folium.Icon(color='green', icon='play')\n                ).add_to(m)\n                \n                if end_lat and end_lng:\n                    folium.Marker(\n                        [float(end_lat), float(end_lng)],\n                        popup=\"End Location\",\n                        icon=folium.Icon(color='red', icon='stop')\n                    ).add_to(m)\n                    \n                    folium.PolyLine(\n                        [[float(start_lat), float(start_lng)], \n                         [float(end_lat), float(end_lng)]],\n                        color='blue',\n                        weight=3,\n                        opacity=0.7\n                    ).add_to(m)\n                \n                try:\n                    gps_points = fetch_data(f\"trips/{trip_id}/gps-route\")\n                    if gps_points:\n                        coordinates = [[float(p['latitude']), float(p['longitude'])] \n                                     for p in gps_points]\n                        folium.PolyLine(\n                            coordinates,\n                            color='red',\n                            weight=2,\n                            opacity=0.8,\n                            popup=\"Actual Route\"\n                        ).add_to(m)\n                except:\n                    pass\n                \n                st_folium(m, width=700, height=500)\n            else:\n                st.info(\"No GPS data available for this trip.\")\n    else:\n        st.info(\"No trips available to display on map.\")\n\nst.sidebar.header(\"About\")\nst.sidebar.info(\n    \"This dashboard displays real-time fleet management data including \"\n    \"trip statistics, driver performance, and route visualization.\"\n)\n","size_bytes":9874},"fleet_management/trips/tests.py":{"content":"from django.test import TestCase\n\n# Create your tests here.\n","size_bytes":60},"fleet_management/asgi.py":{"content":"\"\"\"\nASGI config for fleet_management project.\n\nIt exposes the ASGI callable as a module-level variable named ``application``.\n\nFor more information on this file, see\nhttps://docs.djangoproject.com/en/4.2/howto/deployment/asgi/\n\"\"\"\n\nimport os\n\nfrom django.core.asgi import get_asgi_application\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'fleet_management.settings')\n\napplication = get_asgi_application()\n","size_bytes":409},"fleet_management/trips/__init__.py":{"content":"","size_bytes":0},"trips/migrations/__init__.py":{"content":"","size_bytes":0},"trips/models.py":{"content":"from django.db import models\nfrom django.contrib.auth.models import User\nfrom django.utils import timezone\nfrom geopy.distance import geodesic\n\n\nclass Driver(models.Model):\n    user = models.OneToOneField(User, on_delete=models.CASCADE)\n    phone = models.CharField(max_length=20, blank=True)\n    license_number = models.CharField(max_length=50, blank=True)\n    is_active = models.BooleanField(default=True)\n    created_at = models.DateTimeField(auto_now_add=True)\n\n    def __str__(self):\n        return self.user.get_full_name() or self.user.username\n\n    class Meta:\n        ordering = ['user__first_name', 'user__last_name']\n\n\nclass Vehicle(models.Model):\n    name = models.CharField(max_length=100)\n    registration_number = models.CharField(max_length=50, unique=True)\n    vehicle_type = models.CharField(max_length=50, choices=[\n        ('bakkie', 'Bakkie'),\n        ('van', 'Van'),\n        ('truck', 'Truck'),\n        ('car', 'Car'),\n    ])\n    fuel_capacity = models.DecimalField(max_digits=6, decimal_places=2, help_text='Litres')\n    current_odometer = models.DecimalField(max_digits=10, decimal_places=1, default=0, help_text='Kilometers')\n    is_active = models.BooleanField(default=True)\n    created_at = models.DateTimeField(auto_now_add=True)\n\n    def __str__(self):\n        return f\"{self.name} ({self.registration_number})\"\n\n    class Meta:\n        ordering = ['name']\n\n\nclass Job(models.Model):\n    STATUS_CHOICES = [\n        ('pending', 'Pending'),\n        ('assigned', 'Assigned'),\n        ('in_progress', 'In Progress'),\n        ('completed', 'Completed'),\n        ('cancelled', 'Cancelled'),\n    ]\n\n    job_number = models.CharField(max_length=50, unique=True)\n    customer_name = models.CharField(max_length=200)\n    customer_phone = models.CharField(max_length=20, blank=True)\n    job_location = models.CharField(max_length=500)\n    job_location_lat = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)\n    job_location_lng = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)\n    description = models.TextField()\n    instructions = models.TextField(blank=True)\n    expected_duration = models.IntegerField(help_text='Expected duration in minutes')\n    scheduled_start = models.DateTimeField()\n    assigned_driver = models.ForeignKey(Driver, on_delete=models.SET_NULL, null=True, blank=True, related_name='jobs')\n    assigned_vehicle = models.ForeignKey(Vehicle, on_delete=models.SET_NULL, null=True, blank=True, related_name='jobs')\n    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='pending')\n    created_at = models.DateTimeField(auto_now_add=True)\n    updated_at = models.DateTimeField(auto_now=True)\n\n    def __str__(self):\n        return f\"{self.job_number} - {self.customer_name}\"\n\n    def save(self, *args, **kwargs):\n        if not self.job_number:\n            last_job = Job.objects.order_by('-id').first()\n            if last_job:\n                last_number = int(last_job.job_number.split('-')[1])\n                self.job_number = f'JOB-{last_number + 1:05d}'\n            else:\n                self.job_number = 'JOB-00001'\n        super().save(*args, **kwargs)\n\n    class Meta:\n        ordering = ['-scheduled_start']\n\n\nclass Trip(models.Model):\n    STATUS_CHOICES = [\n        ('started', 'Started'),\n        ('completed', 'Completed'),\n        ('cancelled', 'Cancelled'),\n    ]\n\n    trip_number = models.CharField(max_length=50, unique=True)\n    job = models.ForeignKey(Job, on_delete=models.CASCADE, related_name='trips')\n    driver = models.ForeignKey(Driver, on_delete=models.CASCADE, related_name='trips')\n    vehicle = models.ForeignKey(Vehicle, on_delete=models.CASCADE, related_name='trips')\n    \n    start_time = models.DateTimeField(auto_now_add=True)\n    end_time = models.DateTimeField(null=True, blank=True)\n    \n    start_location_lat = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)\n    start_location_lng = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)\n    end_location_lat = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)\n    end_location_lng = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)\n    \n    start_odometer = models.DecimalField(max_digits=10, decimal_places=1, help_text='Kilometers')\n    end_odometer = models.DecimalField(max_digits=10, decimal_places=1, null=True, blank=True, help_text='Kilometers')\n    \n    start_fuel_level = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True, help_text='Litres or Percentage')\n    end_fuel_level = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True, help_text='Litres or Percentage')\n    \n    distance_travelled = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, help_text='Kilometers')\n    duration_minutes = models.IntegerField(null=True, blank=True)\n    \n    route_compliance = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True, help_text='Percentage')\n    is_after_hours = models.BooleanField(default=False)\n    \n    notes = models.TextField(blank=True)\n    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='started')\n    \n    created_at = models.DateTimeField(auto_now_add=True)\n    updated_at = models.DateTimeField(auto_now=True)\n\n    def __str__(self):\n        return f\"{self.trip_number} - {self.driver} - {self.job.job_number}\"\n\n    def save(self, *args, **kwargs):\n        if not self.trip_number:\n            last_trip = Trip.objects.order_by('-id').first()\n            if last_trip:\n                last_number = int(last_trip.trip_number.split('-')[1])\n                self.trip_number = f'TRIP-{last_number + 1:05d}'\n            else:\n                self.trip_number = 'TRIP-00001'\n        super().save(*args, **kwargs)\n\n    def calculate_metrics(self):\n        if self.end_time:\n            duration = self.end_time - self.start_time\n            self.duration_minutes = int(duration.total_seconds() / 60)\n            \n            if self.end_odometer:\n                self.distance_travelled = self.end_odometer - self.start_odometer\n            \n            if self.start_location_lat and self.start_location_lng and self.end_location_lat and self.end_location_lng:\n                start_coords = (float(self.start_location_lat), float(self.start_location_lng))\n                end_coords = (float(self.end_location_lat), float(self.end_location_lng))\n                gps_distance = geodesic(start_coords, end_coords).kilometers\n                \n                if self.job.job_location_lat and self.job.job_location_lng and gps_distance > 0:\n                    job_coords = (float(self.job.job_location_lat), float(self.job.job_location_lng))\n                    expected_distance = geodesic(start_coords, job_coords).kilometers\n                    \n                    if expected_distance > 0:\n                        self.route_compliance = min(100, (expected_distance / gps_distance) * 100)\n                elif gps_distance == 0:\n                    self.route_compliance = 100\n            \n            start_hour = self.start_time.hour\n            if start_hour < 6 or start_hour >= 18 or self.start_time.weekday() >= 5:\n                self.is_after_hours = True\n            \n            self.save()\n\n    def get_fuel_consumed(self):\n        if self.start_fuel_level and self.end_fuel_level:\n            return float(self.start_fuel_level - self.end_fuel_level)\n        return None\n\n    def get_fuel_efficiency(self):\n        fuel_consumed = self.get_fuel_consumed()\n        if fuel_consumed and self.distance_travelled and fuel_consumed > 0:\n            return float(self.distance_travelled) / fuel_consumed\n        return None\n\n    class Meta:\n        ordering = ['-start_time']\n\n\nclass TripEvent(models.Model):\n    EVENT_TYPES = [\n        ('delay', 'Delay'),\n        ('fuel_stop', 'Fuel Stop'),\n        ('incident', 'Incident/Damage'),\n        ('arrival', 'Arrived at Customer'),\n        ('completed', 'Completed Job'),\n        ('photo', 'Photo Upload'),\n        ('other', 'Other'),\n    ]\n\n    trip = models.ForeignKey(Trip, on_delete=models.CASCADE, related_name='events')\n    event_type = models.CharField(max_length=20, choices=EVENT_TYPES)\n    description = models.TextField()\n    location_lat = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)\n    location_lng = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)\n    photo = models.ImageField(upload_to='trip_events/', null=True, blank=True)\n    timestamp = models.DateTimeField(auto_now_add=True)\n\n    def __str__(self):\n        return f\"{self.trip.trip_number} - {self.get_event_type_display()} - {self.timestamp}\"\n\n    class Meta:\n        ordering = ['timestamp']\n\n\nclass GPSRoutePoint(models.Model):\n    trip = models.ForeignKey(Trip, on_delete=models.CASCADE, related_name='gps_points')\n    latitude = models.DecimalField(max_digits=9, decimal_places=6)\n    longitude = models.DecimalField(max_digits=9, decimal_places=6)\n    speed = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True, help_text='km/h')\n    timestamp = models.DateTimeField(auto_now_add=True)\n\n    def __str__(self):\n        return f\"{self.trip.trip_number} - {self.timestamp}\"\n\n    class Meta:\n        ordering = ['timestamp']\n","size_bytes":9374},"fleet_management/urls.py":{"content":"\"\"\"\nURL configuration for fleet_management project.\n\nThe `urlpatterns` list routes URLs to views. For more information please see:\n    https://docs.djangoproject.com/en/4.2/topics/http/urls/\nExamples:\nFunction views\n    1. Add an import:  from my_app import views\n    2. Add a URL to urlpatterns:  path('', views.home, name='home')\nClass-based views\n    1. Add an import:  from other_app.views import Home\n    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')\nIncluding another URLconf\n    1. Import the include() function: from django.urls import include, path\n    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))\n\"\"\"\nfrom django.contrib import admin\nfrom django.urls import path, include\nfrom django.conf import settings\nfrom django.conf.urls.static import static\n\nurlpatterns = [\n    path('admin/', admin.site.urls),\n    path('accounts/', include('django.contrib.auth.urls')),\n    path('', include('trips.urls')),\n]\n\nif settings.DEBUG:\n    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)\n","size_bytes":1055},"fleet_management/trips/views.py":{"content":"from django.shortcuts import render\n\n# Create your views here.\n","size_bytes":63},"fleet_management/trips/admin.py":{"content":"from django.contrib import admin\n\n# Register your models here.\n","size_bytes":63},"trips/admin.py":{"content":"from django.contrib import admin\nfrom .models import Driver, Vehicle, Job, Trip, TripEvent, GPSRoutePoint\n\n\n@admin.register(Driver)\nclass DriverAdmin(admin.ModelAdmin):\n    list_display = ['get_full_name', 'phone', 'license_number', 'is_active', 'created_at']\n    list_filter = ['is_active', 'created_at']\n    search_fields = ['user__first_name', 'user__last_name', 'user__username', 'phone', 'license_number']\n    \n    def get_full_name(self, obj):\n        return str(obj)\n    get_full_name.short_description = 'Driver Name'\n\n\n@admin.register(Vehicle)\nclass VehicleAdmin(admin.ModelAdmin):\n    list_display = ['name', 'registration_number', 'vehicle_type', 'current_odometer', 'is_active', 'created_at']\n    list_filter = ['vehicle_type', 'is_active', 'created_at']\n    search_fields = ['name', 'registration_number']\n\n\n@admin.register(Job)\nclass JobAdmin(admin.ModelAdmin):\n    list_display = ['job_number', 'customer_name', 'job_location', 'scheduled_start', 'assigned_driver', 'assigned_vehicle', 'status', 'created_at']\n    list_filter = ['status', 'scheduled_start', 'created_at']\n    search_fields = ['job_number', 'customer_name', 'job_location', 'description']\n    raw_id_fields = ['assigned_driver', 'assigned_vehicle']\n    date_hierarchy = 'scheduled_start'\n\n\n@admin.register(Trip)\nclass TripAdmin(admin.ModelAdmin):\n    list_display = ['trip_number', 'job', 'driver', 'vehicle', 'start_time', 'end_time', 'distance_travelled', 'status']\n    list_filter = ['status', 'is_after_hours', 'start_time']\n    search_fields = ['trip_number', 'job__job_number', 'job__customer_name', 'driver__user__first_name', 'driver__user__last_name']\n    raw_id_fields = ['job', 'driver', 'vehicle']\n    date_hierarchy = 'start_time'\n    readonly_fields = ['trip_number', 'start_time', 'created_at', 'updated_at']\n\n\n@admin.register(TripEvent)\nclass TripEventAdmin(admin.ModelAdmin):\n    list_display = ['trip', 'event_type', 'description', 'timestamp']\n    list_filter = ['event_type', 'timestamp']\n    search_fields = ['trip__trip_number', 'description']\n    raw_id_fields = ['trip']\n    date_hierarchy = 'timestamp'\n\n\n@admin.register(GPSRoutePoint)\nclass GPSRoutePointAdmin(admin.ModelAdmin):\n    list_display = ['trip', 'latitude', 'longitude', 'speed', 'timestamp']\n    list_filter = ['timestamp']\n    search_fields = ['trip__trip_number']\n    raw_id_fields = ['trip']\n    date_hierarchy = 'timestamp'\n","size_bytes":2397},"fleet_management/trips/migrations/__init__.py":{"content":"","size_bytes":0},"test_complete_workflow.py":{"content":"import os\nimport django\nfrom decimal import Decimal\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'fleet_management.settings')\ndjango.setup()\n\nfrom django.contrib.auth.models import User\nfrom trips.models import Driver, Vehicle, Job, Trip, TripEvent\nfrom django.utils import timezone\n\nprint(\"=\" * 70)\nprint(\"FLEET MANAGEMENT SYSTEM - END-TO-END WORKFLOW TEST\")\nprint(\"=\" * 70)\n\ndriver_user = User.objects.get(username='john')\ndriver = Driver.objects.get(user=driver_user)\njob = Job.objects.filter(assigned_driver=driver, status='assigned').first()\n\nif not job:\n    print(\"ERROR: No assigned jobs found for driver John\")\n    exit(1)\n\nvehicle_initial_odometer = job.assigned_vehicle.current_odometer\nprint(f\"\\n1. INITIAL STATE:\")\nprint(f\"   Driver: {driver}\")\nprint(f\"   Job: {job.job_number} - {job.customer_name}\")\nprint(f\"   Vehicle: {job.assigned_vehicle}\")\nprint(f\"   Vehicle Odometer: {vehicle_initial_odometer} km\")\n\nprint(f\"\\n2. STARTING TRIP:\")\ntrip = Trip.objects.create(\n    job=job,\n    driver=driver,\n    vehicle=job.assigned_vehicle,\n    start_odometer=Decimal('45230.5'),\n    start_fuel_level=Decimal('75.5'),\n    start_location_lat=Decimal('-26.2041'),\n    start_location_lng=Decimal('28.0473'),\n)\n\njob.status = 'in_progress'\njob.save()\n\nprint(f\"   ✓ Trip {trip.trip_number} created\")\nprint(f\"   Start Time: {trip.start_time}\")\nprint(f\"   Start Odometer: {trip.start_odometer} km\")\nprint(f\"   Start Fuel: {trip.start_fuel_level} L\")\nprint(f\"   Start Location: ({trip.start_location_lat}, {trip.start_location_lng})\")\n\nprint(f\"\\n3. LOGGING TRIP EVENTS:\")\nevent1 = TripEvent.objects.create(\n    trip=trip,\n    event_type='arrival',\n    description='Arrived at customer location',\n    location_lat=Decimal('-26.1076'),\n    location_lng=Decimal('28.0567'),\n)\nprint(f\"   ✓ Event 1: {event1.get_event_type_display()} - {event1.description}\")\n\nevent2 = TripEvent.objects.create(\n    trip=trip,\n    event_type='delay',\n    description='Minor traffic delays on M1',\n)\nprint(f\"   ✓ Event 2: {event2.get_event_type_display()} - {event2.description}\")\n\nevent3 = TripEvent.objects.create(\n    trip=trip,\n    event_type='completed',\n    description='Job completed successfully',\n    location_lat=Decimal('-26.1076'),\n    location_lng=Decimal('28.0567'),\n)\nprint(f\"   ✓ Event 3: {event3.get_event_type_display()} - {event3.description}\")\n\nprint(f\"\\n4. ENDING TRIP:\")\ntrip.end_odometer = Decimal('45264.7')\ntrip.end_fuel_level = Decimal('72.3')\ntrip.end_location_lat = Decimal('-26.1076')\ntrip.end_location_lng = Decimal('28.0567')\ntrip.notes = 'Job completed without issues'\ntrip.end_time = timezone.now()\ntrip.status = 'completed'\ntrip.save()\n\nprint(f\"   End Time: {trip.end_time}\")\nprint(f\"   End Odometer: {trip.end_odometer} km\")\nprint(f\"   End Fuel: {trip.end_fuel_level} L\")\nprint(f\"   End Location: ({trip.end_location_lat}, {trip.end_location_lng})\")\n\nprint(f\"\\n5. CALCULATING METRICS:\")\ntrip.calculate_metrics()\n\ntrip.refresh_from_db()\nprint(f\"   ✓ Distance Travelled: {trip.distance_travelled} km\")\nprint(f\"   ✓ Duration: {trip.duration_minutes} minutes\")\nprint(f\"   ✓ Route Compliance: {trip.route_compliance}%\")\nprint(f\"   ✓ After Hours: {trip.is_after_hours}\")\n\nfuel_consumed = trip.get_fuel_consumed()\nfuel_efficiency = trip.get_fuel_efficiency()\nprint(f\"   ✓ Fuel Consumed: {fuel_consumed} L\")\nprint(f\"   ✓ Fuel Efficiency: {fuel_efficiency:.2f} km/L\" if fuel_efficiency else \"   ✓ Fuel Efficiency: N/A\")\n\nprint(f\"\\n6. UPDATING JOB AND VEHICLE:\")\ntrip.job.status = 'completed'\ntrip.job.save()\nprint(f\"   ✓ Job {trip.job.job_number} marked as completed\")\n\ntrip.vehicle.current_odometer = trip.end_odometer\ntrip.vehicle.save()\n\ntrip.vehicle.refresh_from_db()\nprint(f\"   ✓ Vehicle odometer updated from {vehicle_initial_odometer} to {trip.vehicle.current_odometer} km\")\n\nprint(f\"\\n7. VERIFICATION:\")\ntrip.refresh_from_db()\nerrors = []\n\nif not trip.distance_travelled:\n    errors.append(\"   ✗ Distance travelled not calculated\")\nelse:\n    print(f\"   ✓ Distance travelled: {trip.distance_travelled} km\")\n\nif trip.duration_minutes is None:\n    errors.append(\"   ✗ Duration not calculated\")\nelse:\n    print(f\"   ✓ Duration calculated: {trip.duration_minutes} minutes\")\n\nif trip.route_compliance is None:\n    errors.append(\"   ✗ Route compliance not calculated\")\nelse:\n    print(f\"   ✓ Route compliance calculated: {trip.route_compliance}%\")\n\nif trip.vehicle.current_odometer != trip.end_odometer:\n    errors.append(f\"   ✗ Vehicle odometer not updated correctly\")\nelse:\n    print(f\"   ✓ Vehicle odometer updated correctly: {trip.vehicle.current_odometer} km\")\n\nif trip.job.status != 'completed':\n    errors.append(\"   ✗ Job status not updated\")\nelse:\n    print(f\"   ✓ Job status updated to: {trip.job.status}\")\n\nif trip.events.count() != 3:\n    errors.append(\"   ✗ Events not saved correctly\")\nelse:\n    print(f\"   ✓ All 3 events saved correctly\")\n\nprint(f\"\\n8. FINAL RESULT:\")\nif errors:\n    print(\"   ✗ TEST FAILED - Issues found:\")\n    for error in errors:\n        print(error)\n    exit(1)\nelse:\n    print(\"   ✓ ALL TESTS PASSED!\")\n    print(\"   ✓ Complete workflow (start → log events → end) works reliably\")\n    print(\"   ✓ Automatic calculations persist correctly\")\n    print(\"   ✓ Vehicle odometer updates correctly\")\n    print(\"   ✓ No InvalidOperation or IntegrityError exceptions\")\n\nprint(\"\\n\" + \"=\" * 70)\nprint(\"END-TO-END TEST COMPLETED SUCCESSFULLY\")\nprint(\"=\" * 70)\n","size_bytes":5455},"trips/views.py":{"content":"from django.shortcuts import render, redirect, get_object_or_404\nfrom django.contrib.auth.decorators import login_required\nfrom django.contrib import messages\nfrom django.http import JsonResponse\nfrom django.views.decorators.http import require_http_methods\nfrom rest_framework import viewsets, status\nfrom rest_framework.decorators import action\nfrom rest_framework.response import Response\nfrom .models import Driver, Vehicle, Job, Trip, TripEvent, GPSRoutePoint\nfrom .serializers import (DriverSerializer, VehicleSerializer, JobSerializer,\n                          TripSerializer, TripEventSerializer, GPSRoutePointSerializer)\n\n\n@login_required\ndef driver_dashboard(request):\n    try:\n        driver = Driver.objects.get(user=request.user)\n    except Driver.DoesNotExist:\n        messages.error(request, 'You are not registered as a driver.')\n        return redirect('admin:index')\n    \n    assigned_jobs = Job.objects.filter(assigned_driver=driver, status='assigned')\n    active_trip = Trip.objects.filter(driver=driver, status='started').first()\n    \n    context = {\n        'driver': driver,\n        'assigned_jobs': assigned_jobs,\n        'active_trip': active_trip,\n    }\n    return render(request, 'trips/driver_dashboard.html', context)\n\n\n@login_required\ndef start_trip(request, job_id):\n    try:\n        driver = Driver.objects.get(user=request.user)\n    except Driver.DoesNotExist:\n        messages.error(request, 'You are not registered as a driver.')\n        return redirect('driver_dashboard')\n    \n    job = get_object_or_404(Job, id=job_id, assigned_driver=driver)\n    \n    if request.method == 'POST':\n        start_odometer = request.POST.get('start_odometer')\n        start_fuel_level = request.POST.get('start_fuel_level')\n        start_lat = request.POST.get('start_lat')\n        start_lng = request.POST.get('start_lng')\n        \n        if not start_odometer:\n            messages.error(request, 'Starting odometer reading is required.')\n            return render(request, 'trips/start_trip.html', {'job': job, 'driver': driver})\n        \n        if not start_lat or not start_lng:\n            messages.error(request, 'GPS location is required. Please enable location services.')\n            return render(request, 'trips/start_trip.html', {'job': job, 'driver': driver})\n        \n        try:\n            from decimal import Decimal, InvalidOperation\n            start_odometer_value = Decimal(str(start_odometer))\n        except (ValueError, TypeError, InvalidOperation):\n            messages.error(request, 'Invalid odometer reading.')\n            return render(request, 'trips/start_trip.html', {'job': job, 'driver': driver})\n        \n        try:\n            start_lat_value = Decimal(str(start_lat))\n            start_lng_value = Decimal(str(start_lng))\n        except (ValueError, TypeError, InvalidOperation):\n            messages.error(request, 'Invalid GPS coordinates. Please try again.')\n            return render(request, 'trips/start_trip.html', {'job': job, 'driver': driver})\n        \n        start_fuel_value = None\n        if start_fuel_level:\n            try:\n                start_fuel_value = Decimal(str(start_fuel_level))\n            except (ValueError, TypeError, InvalidOperation):\n                messages.error(request, 'Invalid fuel level.')\n                return render(request, 'trips/start_trip.html', {'job': job, 'driver': driver})\n        \n        trip = Trip.objects.create(\n            job=job,\n            driver=driver,\n            vehicle=job.assigned_vehicle,\n            start_odometer=start_odometer_value,\n            start_fuel_level=start_fuel_value,\n            start_location_lat=start_lat_value,\n            start_location_lng=start_lng_value,\n        )\n        \n        job.status = 'in_progress'\n        job.save()\n        \n        messages.success(request, f'Trip {trip.trip_number} started successfully!')\n        return redirect('active_trip', trip_id=trip.id)\n    \n    context = {\n        'job': job,\n        'driver': driver,\n    }\n    return render(request, 'trips/start_trip.html', context)\n\n\n@login_required\ndef active_trip(request, trip_id):\n    try:\n        driver = Driver.objects.get(user=request.user)\n    except Driver.DoesNotExist:\n        messages.error(request, 'You are not registered as a driver.')\n        return redirect('driver_dashboard')\n    \n    trip = get_object_or_404(Trip, id=trip_id, driver=driver, status='started')\n    events = trip.events.all()\n    \n    context = {\n        'trip': trip,\n        'events': events,\n    }\n    return render(request, 'trips/active_trip.html', context)\n\n\n@login_required\n@require_http_methods([\"POST\"])\ndef add_trip_event(request, trip_id):\n    try:\n        driver = Driver.objects.get(user=request.user)\n    except Driver.DoesNotExist:\n        return JsonResponse({'error': 'Not a driver'}, status=403)\n    \n    trip = get_object_or_404(Trip, id=trip_id, driver=driver, status='started')\n    \n    event_type = request.POST.get('event_type', '').strip()\n    description = request.POST.get('description', '').strip()\n    location_lat = request.POST.get('location_lat')\n    location_lng = request.POST.get('location_lng')\n    photo = request.FILES.get('photo')\n    \n    if not event_type or not description:\n        messages.error(request, 'Event type and description are required.')\n        return redirect('active_trip', trip_id=trip.id)\n    \n    valid_event_types = ['delay', 'fuel_stop', 'incident', 'arrival', 'completed', 'photo', 'other']\n    if event_type not in valid_event_types:\n        messages.error(request, 'Invalid event type.')\n        return redirect('active_trip', trip_id=trip.id)\n    \n    lat_value = None\n    lng_value = None\n    if location_lat and location_lng:\n        try:\n            from decimal import Decimal, InvalidOperation\n            lat_value = Decimal(str(location_lat))\n            lng_value = Decimal(str(location_lng))\n        except (ValueError, TypeError, InvalidOperation):\n            pass\n    \n    event = TripEvent.objects.create(\n        trip=trip,\n        event_type=event_type,\n        description=description,\n        location_lat=lat_value,\n        location_lng=lng_value,\n        photo=photo,\n    )\n    \n    messages.success(request, f'{event.get_event_type_display()} event added successfully!')\n    return redirect('active_trip', trip_id=trip.id)\n\n\n@login_required\ndef end_trip(request, trip_id):\n    try:\n        driver = Driver.objects.get(user=request.user)\n    except Driver.DoesNotExist:\n        messages.error(request, 'You are not registered as a driver.')\n        return redirect('driver_dashboard')\n    \n    trip = get_object_or_404(Trip, id=trip_id, driver=driver, status='started')\n    \n    if request.method == 'POST':\n        end_odometer = request.POST.get('end_odometer')\n        end_lat = request.POST.get('end_lat')\n        end_lng = request.POST.get('end_lng')\n        end_fuel_level = request.POST.get('end_fuel_level')\n        \n        if not end_odometer:\n            messages.error(request, 'Ending odometer reading is required.')\n            return render(request, 'trips/end_trip.html', {'trip': trip})\n        \n        if not end_lat or not end_lng:\n            messages.error(request, 'GPS location is required. Please enable location services.')\n            return render(request, 'trips/end_trip.html', {'trip': trip})\n        \n        try:\n            from decimal import Decimal, InvalidOperation\n            end_odometer_value = Decimal(str(end_odometer))\n            if end_odometer_value < trip.start_odometer:\n                messages.error(request, 'Ending odometer cannot be less than starting odometer.')\n                return render(request, 'trips/end_trip.html', {'trip': trip})\n        except (ValueError, TypeError, InvalidOperation):\n            messages.error(request, 'Invalid odometer reading.')\n            return render(request, 'trips/end_trip.html', {'trip': trip})\n        \n        try:\n            end_lat_value = Decimal(str(end_lat))\n            end_lng_value = Decimal(str(end_lng))\n        except (ValueError, TypeError, InvalidOperation):\n            messages.error(request, 'Invalid GPS coordinates. Please try again.')\n            return render(request, 'trips/end_trip.html', {'trip': trip})\n        \n        end_fuel_value = None\n        if end_fuel_level:\n            try:\n                end_fuel_value = Decimal(str(end_fuel_level))\n            except (ValueError, TypeError, InvalidOperation):\n                messages.error(request, 'Invalid fuel level.')\n                return render(request, 'trips/end_trip.html', {'trip': trip})\n        \n        trip.end_odometer = end_odometer_value\n        trip.end_fuel_level = end_fuel_value\n        trip.end_location_lat = end_lat_value\n        trip.end_location_lng = end_lng_value\n        trip.notes = request.POST.get('notes', '')\n        \n        from django.utils import timezone\n        trip.end_time = timezone.now()\n        trip.status = 'completed'\n        trip.save()\n        \n        trip.calculate_metrics()\n        \n        trip.job.status = 'completed'\n        trip.job.save()\n        \n        trip.vehicle.current_odometer = trip.end_odometer\n        trip.vehicle.save()\n        \n        messages.success(request, f'Trip {trip.trip_number} completed successfully!')\n        return redirect('driver_dashboard')\n    \n    context = {\n        'trip': trip,\n    }\n    return render(request, 'trips/end_trip.html', context)\n\n\nclass DriverViewSet(viewsets.ReadOnlyModelViewSet):\n    queryset = Driver.objects.filter(is_active=True)\n    serializer_class = DriverSerializer\n\n\nclass VehicleViewSet(viewsets.ReadOnlyModelViewSet):\n    queryset = Vehicle.objects.filter(is_active=True)\n    serializer_class = VehicleSerializer\n\n\nclass JobViewSet(viewsets.ReadOnlyModelViewSet):\n    queryset = Job.objects.all()\n    serializer_class = JobSerializer\n    \n    @action(detail=False, methods=['get'])\n    def by_driver(self, request):\n        driver_id = request.query_params.get('driver_id')\n        if driver_id:\n            jobs = self.queryset.filter(assigned_driver_id=driver_id)\n            serializer = self.get_serializer(jobs, many=True)\n            return Response(serializer.data)\n        return Response({'error': 'driver_id parameter required'}, status=400)\n\n\nclass TripViewSet(viewsets.ReadOnlyModelViewSet):\n    queryset = Trip.objects.all()\n    serializer_class = TripSerializer\n    \n    @action(detail=True, methods=['get'])\n    def gps_route(self, request, pk=None):\n        trip = self.get_object()\n        points = trip.gps_points.all()\n        serializer = GPSRoutePointSerializer(points, many=True)\n        return Response(serializer.data)\n    \n    @action(detail=False, methods=['get'])\n    def by_driver(self, request):\n        driver_id = request.query_params.get('driver_id')\n        if driver_id:\n            trips = self.queryset.filter(driver_id=driver_id)\n            serializer = self.get_serializer(trips, many=True)\n            return Response(serializer.data)\n        return Response({'error': 'driver_id parameter required'}, status=400)\n    \n    @action(detail=False, methods=['get'])\n    def active(self, request):\n        active_trips = self.queryset.filter(status='started')\n        serializer = self.get_serializer(active_trips, many=True)\n        return Response(serializer.data)\n\n\nclass TripEventViewSet(viewsets.ReadOnlyModelViewSet):\n    queryset = TripEvent.objects.all()\n    serializer_class = TripEventSerializer\n    \n    @action(detail=False, methods=['get'])\n    def by_trip(self, request):\n        trip_id = request.query_params.get('trip_id')\n        if trip_id:\n            events = self.queryset.filter(trip_id=trip_id)\n            serializer = self.get_serializer(events, many=True)\n            return Response(serializer.data)\n        return Response({'error': 'trip_id parameter required'}, status=400)\n\n\nclass GPSRoutePointViewSet(viewsets.ReadOnlyModelViewSet):\n    queryset = GPSRoutePoint.objects.all()\n    serializer_class = GPSRoutePointSerializer\n","size_bytes":12010},"create_sample_data.py":{"content":"import os\nimport django\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'fleet_management.settings')\ndjango.setup()\n\nfrom django.contrib.auth.models import User\nfrom trips.models import Driver, Vehicle, Job\nfrom django.utils import timezone\nfrom datetime import timedelta\n\nprint(\"Creating sample data...\")\n\nadmin, created = User.objects.get_or_create(\n    username='admin',\n    defaults={\n        'is_superuser': True,\n        'is_staff': True,\n        'first_name': 'Admin',\n        'last_name': 'User'\n    }\n)\nif created:\n    admin.set_password('admin123')\n    admin.save()\n    print(\"Created admin user: username='admin', password='admin123'\")\nelse:\n    print(\"Admin user already exists\")\n\nuser1, created = User.objects.get_or_create(\n    username='john',\n    defaults={\n        'first_name': 'John',\n        'last_name': 'Smith'\n    }\n)\nif created:\n    user1.set_password('driver123')\n    user1.save()\n    print(\"Created driver user: username='john', password='driver123'\")\n\nuser2, created = User.objects.get_or_create(\n    username='sarah',\n    defaults={\n        'first_name': 'Sarah',\n        'last_name': 'Johnson'\n    }\n)\nif created:\n    user2.set_password('driver123')\n    user2.save()\n    print(\"Created driver user: username='sarah', password='driver123'\")\n\ndriver1, created = Driver.objects.get_or_create(\n    user=user1,\n    defaults={\n        'phone': '+27 123 456 789',\n        'license_number': 'DL12345'\n    }\n)\nif created:\n    print(f\"Created driver: {driver1}\")\n\ndriver2, created = Driver.objects.get_or_create(\n    user=user2,\n    defaults={\n        'phone': '+27 987 654 321',\n        'license_number': 'DL54321'\n    }\n)\nif created:\n    print(f\"Created driver: {driver2}\")\n\nvehicle1, created = Vehicle.objects.get_or_create(\n    registration_number='ABC123GP',\n    defaults={\n        'name': 'Bakkie #7',\n        'vehicle_type': 'bakkie',\n        'fuel_capacity': 80,\n        'current_odometer': 45230.5\n    }\n)\nif created:\n    print(f\"Created vehicle: {vehicle1}\")\n\nvehicle2, created = Vehicle.objects.get_or_create(\n    registration_number='XYZ789GP',\n    defaults={\n        'name': 'Van #3',\n        'vehicle_type': 'van',\n        'fuel_capacity': 70,\n        'current_odometer': 32150.2\n    }\n)\nif created:\n    print(f\"Created vehicle: {vehicle2}\")\n\nnow = timezone.now()\n\njob1, created = Job.objects.get_or_create(\n    job_number='JOB-00001',\n    defaults={\n        'customer_name': 'ABC Construction',\n        'customer_phone': '+27 11 123 4567',\n        'job_location': 'Sandton City, Johannesburg',\n        'job_location_lat': -26.1076,\n        'job_location_lng': 28.0567,\n        'description': 'Install water pump at construction site',\n        'instructions': 'Contact site manager John on arrival. Equipment in storage room A.',\n        'expected_duration': 120,\n        'scheduled_start': now + timedelta(hours=1),\n        'assigned_driver': driver1,\n        'assigned_vehicle': vehicle1,\n        'status': 'assigned'\n    }\n)\nif created:\n    print(f\"Created job: {job1}\")\n\njob2, created = Job.objects.get_or_create(\n    job_number='JOB-00002',\n    defaults={\n        'customer_name': 'XYZ Manufacturing',\n        'customer_phone': '+27 11 987 6543',\n        'job_location': 'Midrand Industrial Park, Johannesburg',\n        'job_location_lat': -25.9953,\n        'job_location_lng': 28.1277,\n        'description': 'Repair industrial pump',\n        'instructions': 'Ask for Mr. Patel at reception. Park in loading zone.',\n        'expected_duration': 90,\n        'scheduled_start': now + timedelta(hours=3),\n        'assigned_driver': driver2,\n        'assigned_vehicle': vehicle2,\n        'status': 'assigned'\n    }\n)\nif created:\n    print(f\"Created job: {job2}\")\n\njob3, created = Job.objects.get_or_create(\n    job_number='JOB-00003',\n    defaults={\n        'customer_name': 'Green Valley Estate',\n        'customer_phone': '+27 11 555 7890',\n        'job_location': 'Fourways, Johannesburg',\n        'job_location_lat': -26.0167,\n        'job_location_lng': 28.0004,\n        'description': 'Routine maintenance check',\n        'instructions': 'Security code: 4821. Ask for maintenance supervisor.',\n        'expected_duration': 60,\n        'scheduled_start': now + timedelta(days=1),\n        'assigned_driver': driver1,\n        'assigned_vehicle': vehicle1,\n        'status': 'pending'\n    }\n)\nif created:\n    print(f\"Created job: {job3}\")\n\nprint(\"\\nSample data created successfully!\")\nprint(\"\\n=== Login Credentials ===\")\nprint(\"Admin Panel: username='admin', password='admin123'\")\nprint(\"Driver 1: username='john', password='driver123'\")\nprint(\"Driver 2: username='sarah', password='driver123'\")\nprint(\"\\nAccess the admin panel at: http://0.0.0.0:5000/admin/\")\nprint(\"Access the driver interface at: http://0.0.0.0:5000/\")\n","size_bytes":4762}},"version":2}